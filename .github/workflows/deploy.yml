name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  DEPLOY_PATH: '/home/cdr_admin/PondCDRSuite/cdr_notify'
  BACKUP_PATH: '/home/cdr_admin/PondCDRSuite/cdr_notify_backups'
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Validate remote configuration
      run: |
        ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "test -f ${{ env.DEPLOY_PATH }}/config/config.txt || \
             (echo 'ERROR: config.txt missing' && exit 1)"

    - name: Backup database
      run: |
        ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p ${{ env.BACKUP_PATH }} && \
             if [ -f ${{ env.DEPLOY_PATH }}/cdr_files.db ]; then \
               cp ${{ env.DEPLOY_PATH }}/cdr_files.db \
                  ${{ env.BACKUP_PATH }}/cdr_files.db.\$(date +%Y%m%d_%H%M%S); \
             fi"

    - name: Deploy via rsync
      run: |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
          --exclude='*.pyc' \
          --exclude='__pycache__' \
          --exclude='*.db' \
          --exclude='*.sqlite3' \
          --exclude='config/config.txt' \
          --exclude='secrets/*.env' \
          --exclude='.git' \
          --exclude='venv/' \
          --exclude='.venv/' \
          --exclude='.github/' \
          cdr_notify/ \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/

    - name: Install dependencies
      run: |
        ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && \
             python3 -m venv venv && \
             source venv/bin/activate && \
             pip install --upgrade pip && \
             pip install -r requirements.txt"

    - name: Validate deployment
      run: |
        ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && \
             source venv/bin/activate && \
             python3 -c 'import cdr_notify, database, utils, email_sender, telegram_sender' && \
             echo 'Deployment validation passed'"

    - name: Cleanup
      if: always()
      run: rm -f ~/.ssh/deploy_key
